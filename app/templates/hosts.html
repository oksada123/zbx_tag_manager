{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-server"></i> Manage Hosts</h2>

        <!-- Search and filters bar -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Search and Filters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" id="searchHosts" class="form-control" placeholder="Search by host name...">
                    </div>
                    <div class="col-md-5">
                        <input type="text" id="filterByTag" class="form-control" placeholder="Filter by tag...">
                    </div>
                    <div class="col-md-2">
                        <button id="clearFiltersBtn" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small id="filterStatus" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk operations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Bulk Operations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="bulkTagName" class="form-control" placeholder="Tag name">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="bulkTagValue" class="form-control" placeholder="Tag value (optional)">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success me-2" onclick="bulkAddTags()">
                            <i class="fas fa-plus"></i> Add to selected
                        </button>
                        <button class="btn btn-danger" onclick="bulkRemoveTags()">
                            <i class="fas fa-minus"></i> Remove from selected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hosts list -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Hosts List</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Select all</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">Deselect all</button>
                </div>
            </div>
            <div class="card-body">
                {% if hosts %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll()"></th>
                                <th>Host Name</th>
                                <th>Host</th>
                                <th>Status</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hostsTable">
                            {% for host in hosts %}
                            <tr data-host-name="{{ host.name|lower }}" data-host-tags="{% for tag in host.tags %}{{ tag.tag|lower }} {% endfor %}">
                                <td>
                                    <input type="checkbox" class="host-checkbox" value="{{ host.hostid }}">
                                </td>
                                <td>{{ host.name }}</td>
                                <td>{{ host.host }}</td>
                                <td>
                                    {% if host.status == "0" %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-danger">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for tag in host.tags %}
                                        <span class="badge bg-primary me-1">
                                            {{ tag.tag }}{% if tag.value %}: {{ tag.value }}{% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{{ url_for('host_tags', host_id=host.hostid) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Manage tags
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No hosts found or error fetching data.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Search and filter functions
document.getElementById('searchHosts').addEventListener('input', filterHosts);
document.getElementById('filterByTag').addEventListener('input', filterHosts);

// Add event listeners to host checkboxes after page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener to each host checkbox
    document.querySelectorAll('.host-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });

    // Check filter state after page load and apply them
    initializeFiltersOnLoad();
});

function initializeFiltersOnLoad() {
    const searchTerm = document.getElementById('searchHosts').value.trim();
    const tagFilter = document.getElementById('filterByTag').value.trim();

    if (searchTerm || tagFilter) {
        // If there are values in filters, apply filtering
        filterHosts();
    } else {
        // If filters are empty, hide "Clear" button
        document.getElementById('clearFiltersBtn').style.display = 'none';
    }
}

function filterHosts() {
    const searchTerm = document.getElementById('searchHosts').value.toLowerCase();
    const tagFilter = document.getElementById('filterByTag').value.toLowerCase();
    const rows = document.querySelectorAll('#hostsTable tr');

    let visibleCount = 0;
    let totalCount = 0;

    rows.forEach(row => {
        const hostName = row.getAttribute('data-host-name');
        const hostTags = row.getAttribute('data-host-tags');

        if (hostName && hostTags !== null) { // Check if this is a row with host data
            totalCount++;

            const matchesSearch = !searchTerm || hostName.includes(searchTerm);
            const matchesTag = !tagFilter || (hostTags && hostTags.includes(tagFilter));

            if (matchesSearch && matchesTag) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                // Uncheck hidden hosts
                const checkbox = row.querySelector('.host-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        }
    });

    // Update filter status
    updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount);

    // Update main checkbox state after filtering
    updateSelectAllCheckbox();
}

function updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount) {
    const statusElement = document.getElementById('filterStatus');
    const clearBtn = document.getElementById('clearFiltersBtn');

    const hasFilters = searchTerm || tagFilter;

    if (hasFilters) {
        statusElement.textContent = `Showing ${visibleCount} of ${totalCount} hosts`;
        clearBtn.style.display = '';
    } else {
        statusElement.textContent = '';
        clearBtn.style.display = 'none';
    }
}

// Clear filters function
function clearFilters() {
    // Clear search fields
    document.getElementById('searchHosts').value = '';
    document.getElementById('filterByTag').value = '';

    // Show all rows
    const rows = document.querySelectorAll('#hostsTable tr');
    let totalCount = 0;

    rows.forEach(row => {
        const hostName = row.getAttribute('data-host-name');
        if (hostName) { // Only rows with host data
            totalCount++;
        }
        row.style.display = '';
    });

    // Update filter status
    updateFilterStatus('', '', totalCount, totalCount);

    // Update main checkbox state
    updateSelectAllCheckbox();
}

// Function to update main checkbox state
function updateSelectAllCheckbox() {
    const visibleCheckboxes = [];
    document.querySelectorAll('#hostsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.host-checkbox');
            if (checkbox) {
                visibleCheckboxes.push(checkbox);
            }
        }
    });

    const checkedVisibleCheckboxes = visibleCheckboxes.filter(cb => cb.checked);
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

// Selection functions - only visible hosts
function selectAll() {
    // Select only checkboxes in visible rows
    document.querySelectorAll('#hostsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.host-checkbox');
            if (checkbox) {
                checkbox.checked = true;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    // Uncheck only checkboxes in visible rows
    document.querySelectorAll('#hostsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.host-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    // Toggle only checkboxes in visible rows
    document.querySelectorAll('#hostsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.host-checkbox');
            if (checkbox) {
                checkbox.checked = selectAll;
            }
        }
    });
}

// Bulk operations
function bulkAddTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();
    const tagValue = document.getElementById('bulkTagValue').value.trim();

    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedHosts = getSelectedHosts();
    if (selectedHosts.length === 0) {
        alert('Please select at least one host');
        return;
    }

    if (confirm(`Are you sure you want to add tag "${tagName}" to ${selectedHosts.length} hosts?`)) {
        bulkOperation('add', selectedHosts, tagName, tagValue);
    }
}

function bulkRemoveTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();

    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedHosts = getSelectedHosts();
    if (selectedHosts.length === 0) {
        alert('Please select at least one host');
        return;
    }

    if (confirm(`Are you sure you want to remove tag "${tagName}" from ${selectedHosts.length} hosts?`)) {
        bulkOperation('remove', selectedHosts, tagName, '');
    }
}

function getSelectedHosts() {
    return Array.from(document.querySelectorAll('.host-checkbox:checked')).map(cb => cb.value);
}

function bulkOperation(operation, hostIds, tagName, tagValue) {
    const payload = {
        operation: operation,
        host_ids: hostIds,
        tag: tagName,
        value: tagValue
    };

    fetch('/api/hosts/tags/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error in bulkOperation:', error);
        alert('An error occurred during the operation');
    });
}
</script>
{% endblock %}
