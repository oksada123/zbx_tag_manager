{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-chart-line"></i> Manage Items</h2>

        <!-- Search and filters bar -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Search and Filters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" id="searchItems" class="form-control" placeholder="Search by item name...">
                    </div>
                    <div class="col-md-5">
                        <input type="text" id="filterByTag" class="form-control" placeholder="Filter by tag...">
                    </div>
                    <div class="col-md-2">
                        <button id="clearFiltersBtn" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small id="filterStatus" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk operations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Bulk Operations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="bulkTagName" class="form-control" placeholder="Tag name">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="bulkTagValue" class="form-control" placeholder="Tag value (optional)">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success me-2" onclick="bulkAddTags()">
                            <i class="fas fa-plus"></i> Add to selected
                        </button>
                        <button class="btn btn-danger" onclick="bulkRemoveTags()">
                            <i class="fas fa-minus"></i> Remove from selected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items list -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Items List</h5>
                <div class="d-flex align-items-center gap-3">
                    {% if total_count > 0 %}
                    <div class="d-flex align-items-center">
                        <label for="perPageSelect" class="form-label me-2 mb-0">Per page:</label>
                        <select class="form-select form-select-sm" id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                            <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                            <option value="200" {{ 'selected' if per_page == 200 else '' }}>200</option>
                            <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Select all</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">Deselect all</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading spinner -->
                <div id="loadingSpinner" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading items...</p>
                </div>
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll()"></th>
                                <th>Item Name</th>
                                <th>Key</th>
                                <th>Host</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable">
                            {% for item in items %}
                            <tr data-item-name="{{ item.name|lower }}" data-item-tags="{% for tag in item.tags %}{{ tag.tag|lower }} {% endfor %}">
                                <td>
                                    <input type="checkbox" class="item-checkbox" value="{{ item.itemid }}">
                                </td>
                                <td>{{ item.name }}</td>
                                <td><code class="small">{{ item.key_ }}</code></td>
                                <td>
                                    {% if item.hosts %}
                                        {% for host in item.hosts %}
                                            <small class="text-muted">{{ host.name }}</small>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">No host</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.type == "0" %}
                                        <span class="badge bg-primary">Zabbix agent</span>
                                    {% elif item.type == "2" %}
                                        <span class="badge bg-info">Zabbix trapper</span>
                                    {% elif item.type == "3" %}
                                        <span class="badge bg-secondary">Simple check</span>
                                    {% elif item.type == "7" %}
                                        <span class="badge bg-success">Zabbix agent (active)</span>
                                    {% elif item.type == "10" %}
                                        <span class="badge bg-warning">External check</span>
                                    {% elif item.type == "15" %}
                                        <span class="badge bg-info">Calculated</span>
                                    {% elif item.type == "19" %}
                                        <span class="badge bg-primary">HTTP agent</span>
                                    {% elif item.type == "20" %}
                                        <span class="badge bg-success">SNMP agent</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Type {{ item.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.status == "0" %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-danger">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for tag in item.tags %}
                                        <span class="badge bg-primary me-1">
                                            {{ tag.tag }}{% if tag.value %}: {{ tag.value }}{% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{{ url_for('item_tags', item_id=item.itemid) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Manage tags
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer">
                    {% if total_pages > 1 %}
                    <nav aria-label="Items pagination">
                        <ul class="pagination justify-content-center">
                            <!-- Previous page -->
                            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                                <a class="page-link" href="{{ url_for('items', page=page-1, per_page=per_page) if page > 1 else '#' }}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>

                            <!-- First page -->
                            {% if page > 3 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('items', page=1, per_page=per_page) }}">1</a>
                            </li>
                            {% if page > 4 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                            {% endif %}

                            <!-- Pages around current -->
                            {% for p in range([1, page-2]|max, [total_pages+1, page+3]|min) %}
                            <li class="page-item {{ 'active' if p == page else '' }}">
                                <a class="page-link" href="{{ url_for('items', page=p, per_page=per_page) }}">{{ p }}</a>
                            </li>
                            {% endfor %}

                            <!-- Last page -->
                            {% if page < total_pages - 2 %}
                            {% if page < total_pages - 3 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('items', page=total_pages, per_page=per_page) }}">{{ total_pages }}</a>
                            </li>
                            {% endif %}

                            <!-- Next page -->
                            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                                <a class="page-link" href="{{ url_for('items', page=page+1, per_page=per_page) if page < total_pages else '#' }}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Pagination info -->
                    <div class="text-center text-muted">
                        <small id="paginationInfo">
                            Page {{ page }} of {{ total_pages }}
                            ({{ ((page-1) * per_page + 1) }} - {{ [total_count, page * per_page]|min }} of {{ total_count }} items)
                        </small>
                    </div>
                    {% endif %}
                </div>

                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No items found or error fetching data.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Progress modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalTitle">Bulk Operation</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progressText">Preparing operation...</p>
                <div class="d-flex justify-content-between">
                    <small id="progressCount">0 / 0</small>
                    <small id="progressPercent">0%</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Search and filter functions
document.getElementById('searchItems').addEventListener('input', filterItems);
document.getElementById('filterByTag').addEventListener('input', filterItems);

// Show spinner during loading
document.addEventListener('DOMContentLoaded', function() {
    const itemsTable = document.getElementById('itemsTable');
    const loadingSpinner = document.getElementById('loadingSpinner');

    {% if not items %}
        loadingSpinner.style.display = 'block';
        setTimeout(() => {
            loadingSpinner.style.display = 'none';
        }, 2000);
    {% endif %}

    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });

    initializeFiltersOnLoad();
});

function initializeFiltersOnLoad() {
    const searchTerm = document.getElementById('searchItems').value.trim();
    const tagFilter = document.getElementById('filterByTag').value.trim();

    if (searchTerm || tagFilter) {
        filterItems();
    } else {
        document.getElementById('clearFiltersBtn').style.display = 'none';
    }
}

function filterItems() {
    const searchTerm = document.getElementById('searchItems').value.toLowerCase();
    const tagFilter = document.getElementById('filterByTag').value.toLowerCase();
    const rows = document.querySelectorAll('#itemsTable tr');

    let visibleCount = 0;
    let totalCount = 0;

    rows.forEach(row => {
        const itemName = row.getAttribute('data-item-name');
        const itemTags = row.getAttribute('data-item-tags');

        if (itemName && itemTags !== null) {
            totalCount++;

            const matchesSearch = !searchTerm || itemName.includes(searchTerm);
            const matchesTag = !tagFilter || (itemTags && itemTags.includes(tagFilter));

            if (matchesSearch && matchesTag) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                const checkbox = row.querySelector('.item-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        }
    });

    updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount);
    updateSelectAllCheckbox();
}

function updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount) {
    const statusElement = document.getElementById('filterStatus');
    const clearBtn = document.getElementById('clearFiltersBtn');
    const paginationContainer = document.getElementById('paginationContainer');

    const hasFilters = searchTerm || tagFilter;

    if (hasFilters) {
        statusElement.textContent = `Showing ${visibleCount} of ${totalCount} items`;
        clearBtn.style.display = '';
        if (paginationContainer) {
            paginationContainer.style.display = 'none';
        }
    } else {
        statusElement.textContent = '';
        clearBtn.style.display = 'none';
        if (paginationContainer) {
            paginationContainer.style.display = '';
        }
    }
}

function clearFilters() {
    document.getElementById('searchItems').value = '';
    document.getElementById('filterByTag').value = '';

    const rows = document.querySelectorAll('#itemsTable tr');
    let totalCount = 0;

    rows.forEach(row => {
        const itemName = row.getAttribute('data-item-name');
        if (itemName) {
            totalCount++;
        }
        row.style.display = '';
    });

    updateFilterStatus('', '', totalCount, totalCount);
    updateSelectAllCheckbox();
}

function updateSelectAllCheckbox() {
    const visibleCheckboxes = [];
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                visibleCheckboxes.push(checkbox);
            }
        }
    });

    const checkedVisibleCheckboxes = visibleCheckboxes.filter(cb => cb.checked);
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function selectAll() {
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.checked = true;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.checked = selectAll;
            }
        }
    });
}

// Bulk operations
function bulkAddTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();
    const tagValue = document.getElementById('bulkTagValue').value.trim();

    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedItems = getSelectedItems();
    if (selectedItems.length === 0) {
        alert('Please select at least one item');
        return;
    }

    if (confirm(`Are you sure you want to add tag "${tagName}" to ${selectedItems.length} items?`)) {
        bulkOperation('add', selectedItems, tagName, tagValue);
    }
}

function bulkRemoveTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();

    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedItems = getSelectedItems();
    if (selectedItems.length === 0) {
        alert('Please select at least one item');
        return;
    }

    if (confirm(`Are you sure you want to remove tag "${tagName}" from ${selectedItems.length} items?`)) {
        bulkOperation('remove', selectedItems, tagName, '');
    }
}

function getSelectedItems() {
    return Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
}

async function bulkOperation(operation, itemIds, tagName, tagValue) {
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    const progressCount = document.getElementById('progressCount');
    const progressPercent = document.getElementById('progressPercent');
    const progressTitle = document.getElementById('progressModalTitle');

    progressTitle.textContent = operation === 'add' ? 'Adding Tags' : 'Removing Tags';
    progressText.textContent = `${operation === 'add' ? 'Adding' : 'Removing'} tag "${tagName}" ${operation === 'add' ? 'to' : 'from'} items...`;
    progressCount.textContent = `0 / ${itemIds.length}`;
    progressPercent.textContent = '0%';
    progressBar.style.width = '0%';

    progressModal.show();

    try {
        const batchSize = 10;
        let processed = 0;
        let successful = 0;

        for (let i = 0; i < itemIds.length; i += batchSize) {
            const batch = itemIds.slice(i, i + batchSize);

            const payload = {
                operation: operation,
                item_ids: batch,
                tag: tagName,
                value: tagValue
            };

            try {
                const response = await fetch('/api/items/tags/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    const matches = data.message.match(/(\d+)/);
                    const batchSuccessful = matches ? parseInt(matches[1]) : 0;
                    successful += batchSuccessful;
                }

                processed += batch.length;

                const percent = Math.round((processed / itemIds.length) * 100);
                progressBar.style.width = percent + '%';
                progressCount.textContent = `${processed} / ${itemIds.length}`;
                progressPercent.textContent = percent + '%';

            } catch (error) {
                console.error('Error in batch:', error);
                processed += batch.length;
            }

            await new Promise(resolve => setTimeout(resolve, 100));
        }

        progressModal.hide();

        setTimeout(() => {
            alert(`Operation completed. ${operation === 'add' ? 'Added' : 'Removed'} tag ${operation === 'add' ? 'to' : 'from'} ${successful} items.`);
            location.reload();
        }, 500);

    } catch (error) {
        progressModal.hide();
        console.error('Error in bulkOperation:', error);
        setTimeout(() => {
            alert('An error occurred during the operation');
        }, 500);
    }
}

function changePerPage(newPerPage) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('per_page', newPerPage);
    currentUrl.searchParams.set('page', '1');
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %}
