{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-chart-line"></i> Manage Items</h2>

        <!-- Search and filters bar -->
        <div class="card mb-5">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Search and Filters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <input type="text" id="searchItems" class="form-control" placeholder="Search by item name..." autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <input type="text" id="filterByTag" class="form-control" placeholder="Filter by tag..." autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <select id="filterByType" class="form-select" onchange="filterItems()">
                            <option value="all">All items</option>
                            <option value="editable" selected>Editable only</option>
                            <option value="discovered">Discovered only</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <select id="filterByHost" class="form-select" multiple="multiple" style="flex: 1;">
                                {% for host in all_hosts %}
                                <option value="{{ host.hostid }}">{{ host.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="selectAllHosts()" title="Select all hosts">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearHostSelection()" title="Clear host selection">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small id="filterStatus" class="text-muted"></small>
                            <button id="clearFiltersBtn" class="btn btn-sm btn-outline-secondary" onclick="clearFilters()" style="display: none;">
                                <i class="fas fa-times"></i> Clear All Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk operations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Bulk Operations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="bulkTagName" class="form-control" placeholder="Tag name" autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="bulkTagValue" class="form-control" placeholder="Tag value (optional)" autocomplete="off">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success me-2" onclick="bulkAddTags()">
                            <i class="fas fa-plus"></i> Add to selected
                        </button>
                        <button class="btn btn-danger me-2" onclick="bulkRemoveTags()">
                            <i class="fas fa-minus"></i> Remove from selected
                        </button>
                        <button id="clearBulkBtn" class="btn btn-outline-secondary" onclick="clearBulkFields()" style="display: none;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small id="bulkStatus" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items list -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Items List</h5>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center">
                        <label for="perPageSelect" class="form-label me-2 mb-0">Per page:</label>
                        <select class="form-select form-select-sm" id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                            <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                            <option value="200" {{ 'selected' if per_page == 200 else '' }}>200</option>
                            <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Select all</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">Deselect all</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading spinner -->
                <div id="loadingSpinner" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading items...</p>
                </div>

                <!-- Pagination (top) -->
                <div id="paginationContainerTop" class="mb-3"></div>

                {% if items %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll()"></th>
                                <th class="sortable" onclick="sortManager.sortBy('name', 'data-sort-name', 'string')" style="cursor: pointer;">
                                    Item Name <i id="nameSortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortManager.sortBy('key', 'data-sort-key', 'string')" style="cursor: pointer;">
                                    Key <i id="keySortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortManager.sortBy('hosts', 'data-host-count', 'number')" style="cursor: pointer;">
                                    Hosts <i id="hostsSortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortManager.sortBy('type', 'data-sort-type', 'number')" style="cursor: pointer;">
                                    Type <i id="typeSortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortManager.sortBy('status', 'data-sort-status', 'number')" style="cursor: pointer;">
                                    Status <i id="statusSortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortManager.sortBy('tags', 'data-sort-tags-count', 'number')" style="cursor: pointer;">
                                    Tags <i id="tagsSortIcon" class="fas fa-sort ms-1"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable">
                            {% for item in items %}
                            <tr data-item-name="{{ item.name|lower }}"
                                data-item-tags="{% for tag in item.tags %}{{ tag.tag|lower }}:{{ tag.value|lower if tag.value else '' }} {% endfor %}"
                                data-host-ids="{% for host in item.hosts %}{{ host.hostid }} {% endfor %}"
                                data-host-count="{{ item.host_count }}"
                                data-itemid-host-map='{{ item.itemid_host_map|tojson }}'
                                data-itemid-tags-map='{{ item.itemid_tags_map|tojson }}'
                                data-itemid-flags-map='{{ item.itemid_flags_map|tojson }}'
                                data-has-discovered="{{ 'true' if item.has_discovered else 'false' }}"
                                data-original-index="{{ loop.index0 }}"
                                data-sort-name="{{ item.name|lower }}"
                                data-sort-key="{{ item.key_|lower }}"
                                data-sort-type="{{ item.type }}"
                                data-sort-status="{{ item.status }}"
                                data-sort-tags-count="{{ item.tags|length }}">
                                <td>
                                    <input type="checkbox" class="item-checkbox"
                                           value="{{ item.itemids|join(',') }}">
                                </td>
                                <td>
                                    {{ item.name }}
                                    {% if item.has_discovered %}
                                    <span class="badge bg-warning text-dark ms-1" title="Contains discovered items (LLD) - tags may be read-only">
                                        <i class="fas fa-magic"></i> LLD
                                    </span>
                                    {% endif %}
                                </td>
                                <td><code class="small">{{ item.key_ }}</code></td>
                                <td>
                                    {% if item.hosts|length > 0 %}
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle host-count-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-total-hosts="{{ item.hosts|length }}">
                                                {{ item.hosts|length }} host{{ 's' if item.hosts|length > 1 else '' }}
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-hosts">
                                                {% for host in item.hosts|sort(attribute='name') %}
                                                <li data-host-id="{{ host.hostid }}"><a class="dropdown-item" href="#" onclick="filterBySpecificHost('{{ host.hostid }}'); return false;">{{ host.name }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No host</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.type == "0" %}
                                        <span class="badge bg-primary">Zabbix agent</span>
                                    {% elif item.type == "2" %}
                                        <span class="badge bg-info">Zabbix trapper</span>
                                    {% elif item.type == "3" %}
                                        <span class="badge bg-secondary">Simple check</span>
                                    {% elif item.type == "7" %}
                                        <span class="badge bg-success">Zabbix agent (active)</span>
                                    {% elif item.type == "10" %}
                                        <span class="badge bg-warning">External check</span>
                                    {% elif item.type == "15" %}
                                        <span class="badge bg-info">Calculated</span>
                                    {% elif item.type == "19" %}
                                        <span class="badge bg-primary">HTTP agent</span>
                                    {% elif item.type == "20" %}
                                        <span class="badge bg-success">SNMP agent</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Type {{ item.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.status == "0" %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-danger">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for tag in item.tags %}
                                        <span class="badge bg-primary me-1">
                                            {{ tag.tag }}{% if tag.value %}: {{ tag.value }}{% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{{ url_for('item_tags', item_id=item.itemid) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Manage tags
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination (bottom) -->
                <div id="paginationContainerBottom" class="mt-3"></div>

                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No items found or error fetching data.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Progress modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalTitle">Bulk Operation</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progressText">Preparing operation...</p>
                <div class="d-flex justify-content-between">
                    <small id="progressCount">0 / 0</small>
                    <small id="progressPercent">0%</small>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-danger w-100" id="cancelBulkBtn" onclick="cancelBulkOperation()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i> Note: Canceling will stop the operation, but tags already processed will remain.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dropdown menu for hosts - scrollable with max height */
.dropdown-menu-hosts {
    max-height: 300px;
    overflow-y: auto;
}

/* Sortable column header hover effect */
th.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
</style>

<script>
// Global managers
let sortManager;
let selectionManager;
let paginationManager;
let bulkManager;

// Items-specific: complex filtering with host/tag maps
function getSelectedHostsFromSelect2() {
    const selectedValues = $('#filterByHost').val();
    return selectedValues ? selectedValues : [];
}

// Items-specific: get selected items with filtering by host/tag
function getSelectedItemsWithInfo() {
    const selectedHosts = getSelectedHostsFromSelect2();
    const tagFilter = document.getElementById('filterByTag').value.toLowerCase();
    const selectedItems = [];
    let discoveredCount = 0;

    document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
        const row = cb.closest('tr');
        const allItemIds = cb.value.split(',');
        const itemidHostMap = JSON.parse(row.getAttribute('data-itemid-host-map') || '{}');
        const itemidTagsMap = JSON.parse(row.getAttribute('data-itemid-tags-map') || '{}');
        const itemidFlagsMap = JSON.parse(row.getAttribute('data-itemid-flags-map') || '{}');

        allItemIds.forEach(itemid => {
            const hostId = itemidHostMap[itemid];
            const tagsStr = itemidTagsMap[itemid] || '';
            const flags = itemidFlagsMap[itemid] || '0';

            const matchesHostFilter = selectedHosts.length === 0 || (hostId && selectedHosts.includes(hostId));
            const matchesTagFilter = !tagFilter || tagsStr.includes(tagFilter);

            if (matchesHostFilter && matchesTagFilter) {
                selectedItems.push(itemid);
                if (flags === '4') {
                    discoveredCount++;
                }
            }
        });
    });

    return { items: selectedItems, total: selectedItems.length, discovered: discoveredCount };
}

// Items-specific: update host dropdown visibility
function updateHostDropdown(row, tagFilter, matchingHostIdsByTag) {
    const dropdown = row.querySelector('.dropdown');
    if (!dropdown) return;

    const button = dropdown.querySelector('.host-count-btn');
    const items = dropdown.querySelectorAll('.dropdown-menu li');
    const totalHosts = parseInt(button.getAttribute('data-total-hosts') || '0');
    const selectedHosts = getSelectedHostsFromSelect2();

    let visibleHostCount = 0;

    items.forEach(item => {
        const hostId = item.getAttribute('data-host-id');
        let shouldShow = true;

        if (tagFilter && !matchingHostIdsByTag.includes(hostId)) {
            shouldShow = false;
        }
        if (selectedHosts.length > 0 && !selectedHosts.includes(hostId)) {
            shouldShow = false;
        }

        if (shouldShow) {
            item.style.display = '';
            visibleHostCount++;
        } else {
            item.style.display = 'none';
        }
    });

    if (!tagFilter && selectedHosts.length === 0) {
        button.textContent = totalHosts === 1 ? '1 host' : `${totalHosts} hosts`;
    } else {
        button.textContent = visibleHostCount === 1 ? '1 host' : `${visibleHostCount} hosts`;
    }
}

// Items-specific: complex filtering with host selection and tag maps
function filterItems() {
    const searchTerm = document.getElementById('searchItems').value.toLowerCase();
    const tagFilter = document.getElementById('filterByTag').value.toLowerCase();
    const typeFilter = document.getElementById('filterByType').value;
    const selectedHosts = getSelectedHostsFromSelect2();
    const rows = document.querySelectorAll('#itemsTable tr');

    let visibleCount = 0;
    let totalCount = 0;

    rows.forEach(row => {
        const itemName = row.getAttribute('data-item-name');
        const itemTags = row.getAttribute('data-item-tags');
        const hostIds = row.getAttribute('data-host-ids');
        const hasDiscovered = row.getAttribute('data-has-discovered') === 'true';

        if (itemName && itemTags !== null) {
            totalCount++;

            const matchesSearch = !searchTerm || itemName.includes(searchTerm);

            let matchesType = true;
            if (typeFilter === 'editable') {
                matchesType = !hasDiscovered;
            } else if (typeFilter === 'discovered') {
                matchesType = hasDiscovered;
            }

            const itemidTagsMap = JSON.parse(row.getAttribute('data-itemid-tags-map') || '{}');
            const itemidHostMap = JSON.parse(row.getAttribute('data-itemid-host-map') || '{}');

            let matchingHostIds = [];
            if (tagFilter) {
                for (const [itemid, tagsStr] of Object.entries(itemidTagsMap)) {
                    if (tagsStr.includes(tagFilter)) {
                        const hostId = itemidHostMap[itemid];
                        if (hostId && !matchingHostIds.includes(hostId)) {
                            matchingHostIds.push(hostId);
                        }
                    }
                }
            }

            const matchesTag = !tagFilter || matchingHostIds.length > 0;

            let matchesHost = selectedHosts.length === 0;
            if (!matchesHost && hostIds) {
                const itemHostIds = hostIds.trim().split(/\s+/);
                matchesHost = selectedHosts.some(selectedHost => itemHostIds.includes(selectedHost));
            }

            if (matchesSearch && matchesTag && matchesHost && matchesType) {
                row.style.display = '';
                visibleCount++;
                updateHostDropdown(row, tagFilter, matchingHostIds);
            } else {
                row.style.display = 'none';
                const checkbox = row.querySelector('.item-checkbox');
                if (checkbox) checkbox.checked = false;
            }
        }
    });

    updateItemsFilterStatus(searchTerm, tagFilter, selectedHosts.length, visibleCount, totalCount, typeFilter);
    selectionManager.updateSelectAllCheckbox();
    if (paginationManager) paginationManager.showPage(1);
}

function updateItemsFilterStatus(searchTerm, tagFilter, hostCount, visibleCount, totalCount, typeFilter) {
    const statusElement = document.getElementById('filterStatus');
    const clearBtn = document.getElementById('clearFiltersBtn');

    const hasFilters = searchTerm || tagFilter || hostCount > 0 || typeFilter !== 'all';

    if (hasFilters) {
        let statusParts = [];
        if (searchTerm) statusParts.push(`name: "${searchTerm}"`);
        if (tagFilter) statusParts.push(`tag: "${tagFilter}"`);
        if (hostCount > 0) statusParts.push(`${hostCount} host${hostCount > 1 ? 's' : ''}`);
        if (typeFilter === 'editable') statusParts.push('editable only');
        if (typeFilter === 'discovered') statusParts.push('discovered only');

        statusElement.textContent = `Showing ${visibleCount} of ${totalCount} items (filtered by ${statusParts.join(', ')})`;
        clearBtn.style.display = '';
    } else {
        statusElement.textContent = '';
        clearBtn.style.display = 'none';
    }
}

// Initialize all managers on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if not items %}
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
        setTimeout(() => { loadingSpinner.style.display = 'none'; }, 2000);
    }
    {% endif %}

    // Initialize Selection Manager
    selectionManager = new SelectionManager({
        tableId: 'itemsTable',
        checkboxClass: 'item-checkbox',
        rowDataAttr: 'data-item-name',
        discoveredAttr: 'data-has-discovered',
        onSelectionChange: () => updateBulkStatus()
    });

    // Initialize Bulk Operations Manager (custom for items)
    bulkManager = new BulkOperationsManager({
        apiEndpoint: '/api/items/tags/bulk',
        entityName: 'items',
        entityIdField: 'item_ids',
        storageKeyPrefix: 'bulkTagName_items',
        getSelectedItems: () => getSelectedItemsWithInfo().items,
        getSelectionInfo: () => getSelectedItemsWithInfo()
    });

    // Initialize Pagination Manager
    paginationManager = new PaginationManager({
        tableId: 'itemsTable',
        rowDataAttr: 'data-item-name',
        itemsPerPage: {{ per_page }},
        entityName: 'items',
        onPageChange: () => selectionManager.updateSelectAllCheckbox()
    });

    // Initialize Sort Manager
    sortManager = new TableSortManager('itemsTable', {
        onSort: function() {
            paginationManager.refreshRows();
            paginationManager.showPage(1);
        }
    });

    // Initialize Select2 for host filter
    $('#filterByHost').select2({
        placeholder: 'Filter by host...',
        allowClear: true,
        theme: 'bootstrap-5',
        width: '100%',
        closeOnSelect: false
    });

    $('#filterByHost').on('change', filterItems);

    $('#filterByHost').on('select2:open', function() {
        setTimeout(() => {
            const dropdown = $('.select2-dropdown');
            if (!dropdown.find('.select-all-filtered-btn').length) {
                dropdown.prepend(`
                    <div class="select-all-filtered-btn" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="selectFilteredHosts(); event.stopPropagation();">
                            <i class="fas fa-check-double me-1"></i> Select All Filtered
                        </button>
                    </div>
                `);
            }
        }, 10);
    });

    // Add search and filter listeners
    document.getElementById('searchItems').addEventListener('input', filterItems);
    document.getElementById('filterByTag').addEventListener('input', filterItems);
    document.getElementById('filterByType').addEventListener('change', filterItems);

    // Initialize filters on load
    const searchTerm = document.getElementById('searchItems').value.trim();
    const tagFilter = document.getElementById('filterByTag').value.trim();
    const typeFilter = document.getElementById('filterByType').value;
    if (searchTerm || tagFilter || typeFilter !== 'all' || getSelectedHostsFromSelect2().length > 0) {
        filterItems();
    } else {
        document.getElementById('clearFiltersBtn').style.display = 'none';
    }
});

// Items-specific bulk status (shows item instances vs groups)
function updateBulkStatus() {
    const info = getSelectedItemsWithInfo();
    const statusElement = document.getElementById('bulkStatus');
    const rowCount = document.querySelectorAll('.item-checkbox:checked').length;

    const tagName = document.getElementById('bulkTagName').value.trim();
    const tagValue = document.getElementById('bulkTagValue').value.trim();
    const hasInput = tagName || tagValue;

    if (rowCount > 0 || hasInput) {
        if (rowCount === 0) {
            statusElement.textContent = 'No items selected';
        } else {
            let statusText = '';
            if (info.total === rowCount) {
                statusText = info.total === 1 ? '1 item instance selected' : `${info.total} item instances selected`;
            } else {
                statusText = `${rowCount} item groups selected (${info.total} item instances)`;
            }
            if (info.discovered > 0) {
                statusText += ` - ${info.discovered} discovered (may fail)`;
            }
            statusElement.textContent = statusText;
        }
    } else {
        statusElement.textContent = '';
    }
}

// Wrapper functions for HTML onclick handlers
function cancelBulkOperation() {
    bulkManager.cancelCurrentOperation();
}

function clearFilters() {
    document.getElementById('searchItems').value = '';
    document.getElementById('filterByTag').value = '';
    document.getElementById('filterByType').value = 'all';
    $('#filterByHost').val(null).trigger('change');

    const rows = document.querySelectorAll('#itemsTable tr');
    let totalCount = 0;
    rows.forEach(row => {
        const itemName = row.getAttribute('data-item-name');
        if (itemName) {
            totalCount++;
            updateHostDropdown(row, '', []);
        }
        row.style.display = '';
    });

    updateItemsFilterStatus('', '', 0, totalCount, totalCount, 'all');
    selectionManager.updateSelectAllCheckbox();
    if (paginationManager) paginationManager.showPage(1);
}

function selectAll() {
    selectionManager.selectAll();
}

function deselectAll() {
    selectionManager.deselectAll();
}

function toggleAll() {
    selectionManager.toggleAll();
}

function clearBulkFields() {
    bulkManager.clearFields();
}

function bulkAddTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();
    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedItems = getSelectedItemsWithInfo().items;
    if (selectedItems.length === 0) {
        alert('Please select at least one item');
        return;
    }

    const selectedHosts = getSelectedHostsFromSelect2();
    const tagFilterValue = document.getElementById('filterByTag').value.trim();

    let confirmMessage = `Are you sure you want to add tag "${tagName}" to ${selectedItems.length} item instances?`;
    let filterInfo = [];
    if (selectedHosts.length > 0) filterInfo.push(`${selectedHosts.length} host${selectedHosts.length > 1 ? 's' : ''}`);
    if (tagFilterValue) filterInfo.push(`tag: "${tagFilterValue}"`);
    if (filterInfo.length > 0) confirmMessage += `\n\n(Filtered by ${filterInfo.join(', ')})`;

    if (confirm(confirmMessage)) {
        bulkManager.performOperation('add', selectedItems, tagName, document.getElementById('bulkTagValue').value.trim());
    }
}

function bulkRemoveTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();
    if (!tagName) {
        alert('Please provide a tag name');
        return;
    }

    const selectedItems = getSelectedItemsWithInfo().items;
    if (selectedItems.length === 0) {
        alert('Please select at least one item');
        return;
    }

    const selectedHosts = getSelectedHostsFromSelect2();
    const tagFilterValue = document.getElementById('filterByTag').value.trim();

    let confirmMessage = `Are you sure you want to remove tag "${tagName}" from ${selectedItems.length} item instances?`;
    let filterInfo = [];
    if (selectedHosts.length > 0) filterInfo.push(`${selectedHosts.length} host${selectedHosts.length > 1 ? 's' : ''}`);
    if (tagFilterValue) filterInfo.push(`tag: "${tagFilterValue}"`);
    if (filterInfo.length > 0) confirmMessage += `\n\n(Filtered by ${filterInfo.join(', ')})`;

    if (confirm(confirmMessage)) {
        bulkManager.performOperation('remove', selectedItems, tagName, '');
    }
}

function changePerPage(newPerPage) {
    paginationManager.changePerPage(newPerPage);
}

// Select2 helper functions
function selectAllHosts() {
    const select2Instance = $('#filterByHost').data('select2');
    let searchText = '';
    if (select2Instance && select2Instance.$dropdown) {
        const searchField = select2Instance.$dropdown.find('.select2-search__field');
        if (searchField.length) searchText = searchField.val() || '';
    }

    if (searchText.trim() !== '') {
        const filteredHostIds = [];
        const searchLower = searchText.toLowerCase();
        $('#filterByHost option').each(function() {
            if ($(this).text().toLowerCase().includes(searchLower)) {
                filteredHostIds.push($(this).val());
            }
        });
        const currentSelection = $('#filterByHost').val() || [];
        $('#filterByHost').val([...new Set([...currentSelection, ...filteredHostIds])]).trigger('change');
    } else {
        const allHostIds = [];
        $('#filterByHost option').each(function() { allHostIds.push($(this).val()); });
        $('#filterByHost').val(allHostIds).trigger('change');
    }
}

function clearHostSelection() {
    $('#filterByHost').val(null).trigger('change');
}

function selectFilteredHosts() {
    const searchField = $('.select2-search__field');
    const searchText = searchField.length ? searchField.val() || '' : '';

    if (searchText.trim() === '') {
        selectAllHosts();
        return;
    }

    const filteredHostIds = [];
    const searchLower = searchText.toLowerCase().trim();
    $('#filterByHost option').each(function() {
        if ($(this).text().toLowerCase().includes(searchLower)) {
            filteredHostIds.push($(this).val());
        }
    });

    if (filteredHostIds.length === 0) return;

    const currentSelection = $('#filterByHost').val() || [];
    $('#filterByHost').val([...new Set([...currentSelection, ...filteredHostIds])]).trigger('change');
    $('#filterByHost').select2('open');
}

function filterBySpecificHost(hostId) {
    const currentSelection = $('#filterByHost').val() || [];
    if (!currentSelection.includes(hostId)) {
        currentSelection.push(hostId);
        $('#filterByHost').val(currentSelection).trigger('change');
    }
}
</script>
{% endblock %}
