{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-exclamation-triangle"></i> Zarządzanie triggerami</h2>

        <!-- Pasek wyszukiwania i filtrów -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Wyszukiwanie i filtry</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" id="searchTriggers" class="form-control" placeholder="Szukaj po nazwie triggera...">
                    </div>
                    <div class="col-md-5">
                        <input type="text" id="filterByTag" class="form-control" placeholder="Filtruj po tagu...">
                    </div>
                    <div class="col-md-2">
                        <button id="clearFiltersBtn" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Wyczyść
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small id="filterStatus" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operacje masowe -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Operacje masowe</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="bulkTagName" class="form-control" placeholder="Nazwa tagu">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="bulkTagValue" class="form-control" placeholder="Wartość tagu (opcjonalna)">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success me-2" onclick="bulkAddTags()">
                            <i class="fas fa-plus"></i> Dodaj do zaznaczonych
                        </button>
                        <button class="btn btn-danger" onclick="bulkRemoveTags()">
                            <i class="fas fa-minus"></i> Usuń z zaznaczonych
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista triggerów -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Lista triggerów</h5>
                <div class="d-flex align-items-center gap-3">
                    {% if total_count > 0 %}
                    <div class="d-flex align-items-center">
                        <label for="perPageSelect" class="form-label me-2 mb-0">Na stronie:</label>
                        <select class="form-select form-select-sm" id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                            <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                            <option value="200" {{ 'selected' if per_page == 200 else '' }}>200</option>
                            <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Zaznacz wszystkie</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">Odznacz wszystkie</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Spinner ładowania -->
                <div id="loadingSpinner" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Ładowanie...</span>
                    </div>
                    <p class="mt-2">Ładowanie triggerów...</p>
                </div>
                {% if triggers %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll()"></th>
                                <th>Opis triggera</th>
                                <th>Host</th>
                                <th>Priorytet</th>
                                <th>Status</th>
                                <th>Tagi</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="triggersTable">
                            {% for trigger in triggers %}
                            <tr data-trigger-name="{{ trigger.description|lower }}" data-trigger-tags="{% for tag in trigger.tags %}{{ tag.tag|lower }} {% endfor %}">
                                <td>
                                    <input type="checkbox" class="trigger-checkbox" value="{{ trigger.triggerid }}">
                                </td>
                                <td>{{ trigger.description }}</td>
                                <td>
                                    {% if trigger.hosts %}
                                        {% for host in trigger.hosts %}
                                            <small class="text-muted">{{ host.name }}</small>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">Brak hosta</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trigger.priority == "0" %}
                                        <span class="badge bg-secondary">Nieustalony</span>
                                    {% elif trigger.priority == "1" %}
                                        <span class="badge bg-info">Informacja</span>
                                    {% elif trigger.priority == "2" %}
                                        <span class="badge bg-warning">Ostrzeżenie</span>
                                    {% elif trigger.priority == "3" %}
                                        <span class="badge bg-warning">Średni</span>
                                    {% elif trigger.priority == "4" %}
                                        <span class="badge bg-danger">Wysoki</span>
                                    {% elif trigger.priority == "5" %}
                                        <span class="badge bg-danger">Krytyczny</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ trigger.priority }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trigger.status == "0" %}
                                        <span class="badge bg-success">Aktywny</span>
                                    {% else %}
                                        <span class="badge bg-danger">Nieaktywny</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for tag in trigger.tags %}
                                        <span class="badge bg-primary me-1">
                                            {{ tag.tag }}{% if tag.value %}: {{ tag.value }}{% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{{ url_for('trigger_tags', trigger_id=trigger.triggerid) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Zarządzaj tagami
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginacja -->
                <div id="paginationContainer">
                    {% if total_pages > 1 %}
                    <nav aria-label="Paginacja triggerów">
                        <ul class="pagination justify-content-center">
                            <!-- Poprzednia strona -->
                            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                                <a class="page-link" href="{{ url_for('triggers', page=page-1, per_page=per_page) if page > 1 else '#' }}">
                                    <i class="fas fa-chevron-left"></i> Poprzednia
                                </a>
                            </li>

                            <!-- Pierwsza strona -->
                            {% if page > 3 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('triggers', page=1, per_page=per_page) }}">1</a>
                            </li>
                            {% if page > 4 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                            {% endif %}

                            <!-- Strony wokół bieżącej -->
                            {% for p in range([1, page-2]|max, [total_pages+1, page+3]|min) %}
                            <li class="page-item {{ 'active' if p == page else '' }}">
                                <a class="page-link" href="{{ url_for('triggers', page=p, per_page=per_page) }}">{{ p }}</a>
                            </li>
                            {% endfor %}

                            <!-- Ostatnia strona -->
                            {% if page < total_pages - 2 %}
                            {% if page < total_pages - 3 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('triggers', page=total_pages, per_page=per_page) }}">{{ total_pages }}</a>
                            </li>
                            {% endif %}

                            <!-- Następna strona -->
                            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                                <a class="page-link" href="{{ url_for('triggers', page=page+1, per_page=per_page) if page < total_pages else '#' }}">
                                    Następna <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Informacja o paginacji -->
                    <div class="text-center text-muted">
                        <small id="paginationInfo">
                            Strona {{ page }} z {{ total_pages }}
                            ({{ ((page-1) * per_page + 1) }} - {{ [total_count, page * per_page]|min }} z {{ total_count }} triggerów)
                        </small>
                    </div>
                    {% endif %}
                </div>

                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Nie znaleziono triggerów lub wystąpił błąd podczas pobierania danych.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal z paskiem postępu -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalTitle">Operacja masowa</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progressText">Przygotowywanie operacji...</p>
                <div class="d-flex justify-content-between">
                    <small id="progressCount">0 / 0</small>
                    <small id="progressPercent">0%</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Funkcje wyszukiwania i filtrowania
document.getElementById('searchTriggers').addEventListener('input', filterTriggers);
document.getElementById('filterByTag').addEventListener('input', filterTriggers);

// Pokaż spinner podczas ładowania
document.addEventListener('DOMContentLoaded', function() {
    // Sprawdź czy mamy triggery
    const triggersTable = document.getElementById('triggersTable');
    const loadingSpinner = document.getElementById('loadingSpinner');

    {% if not triggers %}
        // Jeśli brak triggerów, pokaż spinner na 2 sekundy (symulacja ładowania)
        loadingSpinner.style.display = 'block';
        setTimeout(() => {
            loadingSpinner.style.display = 'none';
        }, 2000);
    {% endif %}

    // Dodaj event listener do każdego checkbox'a triggera
    document.querySelectorAll('.trigger-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });

    // Sprawdź stan filtrów po załadowaniu strony i zastosuj je
    initializeFiltersOnLoad();
});

function initializeFiltersOnLoad() {
    const searchTerm = document.getElementById('searchTriggers').value.trim();
    const tagFilter = document.getElementById('filterByTag').value.trim();

    if (searchTerm || tagFilter) {
        // Jeśli są wartości w filtrach, zastosuj filtrowanie
        filterTriggers();
    } else {
        // Jeśli filtry są puste, ukryj przycisk "Wyczyść"
        document.getElementById('clearFiltersBtn').style.display = 'none';
    }
}

function filterTriggers() {
    const searchTerm = document.getElementById('searchTriggers').value.toLowerCase();
    const tagFilter = document.getElementById('filterByTag').value.toLowerCase();
    const rows = document.querySelectorAll('#triggersTable tr');

    let visibleCount = 0;
    let totalCount = 0;

    rows.forEach(row => {
        const triggerName = row.getAttribute('data-trigger-name');
        const triggerTags = row.getAttribute('data-trigger-tags');

        if (triggerName && triggerTags !== null) { // Sprawdź czy to wiersz z danymi triggerów
            totalCount++;

            const matchesSearch = !searchTerm || triggerName.includes(searchTerm);
            const matchesTag = !tagFilter || (triggerTags && triggerTags.includes(tagFilter));

            if (matchesSearch && matchesTag) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                // Odznacz ukryte triggery
                const checkbox = row.querySelector('.trigger-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        }
    });

    // Zaktualizuj status filtrowania
    updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount);

    // Zaktualizuj stan głównego checkbox'a po filtrowaniu
    updateSelectAllCheckbox();
}

function updateFilterStatus(searchTerm, tagFilter, visibleCount, totalCount) {
    const statusElement = document.getElementById('filterStatus');
    const clearBtn = document.getElementById('clearFiltersBtn');
    const paginationContainer = document.getElementById('paginationContainer');

    const hasFilters = searchTerm || tagFilter;

    if (hasFilters) {
        statusElement.textContent = `Pokazano ${visibleCount} z ${totalCount} triggerów`;
        clearBtn.style.display = '';
        // Ukryj paginację podczas filtrowania
        if (paginationContainer) {
            paginationContainer.style.display = 'none';
        }
    } else {
        statusElement.textContent = '';
        clearBtn.style.display = 'none';
        // Pokaż paginację gdy brak filtrów
        if (paginationContainer) {
            paginationContainer.style.display = '';
        }
    }
}

// Funkcja czyszczenia filtrów
function clearFilters() {
    // Wyczyść pola wyszukiwania
    document.getElementById('searchTriggers').value = '';
    document.getElementById('filterByTag').value = '';

    // Pokaż wszystkie wiersze
    const rows = document.querySelectorAll('#triggersTable tr');
    let totalCount = 0;

    rows.forEach(row => {
        const triggerName = row.getAttribute('data-trigger-name');
        if (triggerName) { // Tylko wiersze z danymi triggerów
            totalCount++;
        }
        row.style.display = '';
    });

    // Zaktualizuj status filtrowania
    updateFilterStatus('', '', totalCount, totalCount);

    // Zaktualizuj stan głównego checkbox'a
    updateSelectAllCheckbox();
}

// Funkcja do aktualizacji stanu głównego checkbox'a
function updateSelectAllCheckbox() {
    const visibleCheckboxes = [];
    document.querySelectorAll('#triggersTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.trigger-checkbox');
            if (checkbox) {
                visibleCheckboxes.push(checkbox);
            }
        }
    });

    const checkedVisibleCheckboxes = visibleCheckboxes.filter(cb => cb.checked);
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedVisibleCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

// Funkcje zaznaczania - tylko widoczne triggery
function selectAll() {
    // Zaznacz tylko checkbox'y w widocznych wierszach
    document.querySelectorAll('#triggersTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.trigger-checkbox');
            if (checkbox) {
                checkbox.checked = true;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    // Odznacz tylko checkbox'y w widocznych wierszach
    document.querySelectorAll('#triggersTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.trigger-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    });
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    // Toggle tylko checkbox'y w widocznych wierszach
    document.querySelectorAll('#triggersTable tr').forEach(row => {
        if (row.style.display !== 'none') {
            const checkbox = row.querySelector('.trigger-checkbox');
            if (checkbox) {
                checkbox.checked = selectAll;
            }
        }
    });
}

// Operacje masowe
function bulkAddTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();
    const tagValue = document.getElementById('bulkTagValue').value.trim();

    if (!tagName) {
        alert('Podaj nazwę tagu');
        return;
    }

    const selectedTriggers = getSelectedTriggers();
    if (selectedTriggers.length === 0) {
        alert('Zaznacz przynajmniej jeden trigger');
        return;
    }

    if (confirm(`Czy na pewno chcesz dodać tag "${tagName}" do ${selectedTriggers.length} triggerów?`)) {
        bulkOperation('add', selectedTriggers, tagName, tagValue);
    }
}

function bulkRemoveTags() {
    const tagName = document.getElementById('bulkTagName').value.trim();

    if (!tagName) {
        alert('Podaj nazwę tagu');
        return;
    }

    const selectedTriggers = getSelectedTriggers();
    if (selectedTriggers.length === 0) {
        alert('Zaznacz przynajmniej jeden trigger');
        return;
    }

    if (confirm(`Czy na pewno chcesz usunąć tag "${tagName}" z ${selectedTriggers.length} triggerów?`)) {
        bulkOperation('remove', selectedTriggers, tagName, '');
    }
}

function getSelectedTriggers() {
    return Array.from(document.querySelectorAll('.trigger-checkbox:checked')).map(cb => cb.value);
}

async function bulkOperation(operation, triggerIds, tagName, tagValue) {
    // Pokaż modal z paskiem postępu
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    const progressCount = document.getElementById('progressCount');
    const progressPercent = document.getElementById('progressPercent');
    const progressTitle = document.getElementById('progressModalTitle');

    progressTitle.textContent = operation === 'add' ? 'Dodawanie tagów' : 'Usuwanie tagów';
    progressText.textContent = `${operation === 'add' ? 'Dodawanie' : 'Usuwanie'} tagu "${tagName}" ${operation === 'add' ? 'do' : 'z'} triggerów...`;
    progressCount.textContent = `0 / ${triggerIds.length}`;
    progressPercent.textContent = '0%';
    progressBar.style.width = '0%';

    progressModal.show();

    try {
        // Przetwarzaj triggery w małych paczkach aby pokazać postęp
        const batchSize = 10;
        let processed = 0;
        let successful = 0;

        for (let i = 0; i < triggerIds.length; i += batchSize) {
            const batch = triggerIds.slice(i, i + batchSize);

            const payload = {
                operation: operation,
                trigger_ids: batch,
                tag: tagName,
                value: tagValue
            };

            try {
                const response = await fetch('/api/triggers/tags/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    // Wyciągnij liczbę z wiadomości np. "Tag dodany do 5 triggerów"
                    const matches = data.message.match(/(\d+)/);
                    const batchSuccessful = matches ? parseInt(matches[1]) : 0;
                    successful += batchSuccessful;
                }

                processed += batch.length;

                // Aktualizuj pasek postępu
                const percent = Math.round((processed / triggerIds.length) * 100);
                progressBar.style.width = percent + '%';
                progressCount.textContent = `${processed} / ${triggerIds.length}`;
                progressPercent.textContent = percent + '%';

            } catch (error) {
                console.error('Error in batch:', error);
                processed += batch.length;
            }

            // Krótka pauza aby nie przeciążać serwera
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Ukryj modal i pokaż wynik
        progressModal.hide();

        setTimeout(() => {
            alert(`Operacja zakończona. ${operation === 'add' ? 'Dodano' : 'Usunięto'} tag ${operation === 'add' ? 'do' : 'z'} ${successful} triggerów.`);
            location.reload();
        }, 500);

    } catch (error) {
        progressModal.hide();
        console.error('Error in bulkOperation:', error);
        setTimeout(() => {
            alert('Wystąpił błąd podczas operacji');
        }, 500);
    }
}

// Funkcja zmiany liczby elementów na stronie
function changePerPage(newPerPage) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('per_page', newPerPage);
    currentUrl.searchParams.set('page', '1'); // Reset do pierwszej strony
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %}